# precondition for all functions here is that ros is initialized

function dispatch_trajectory(traj::AbstractMatrix, dt::Float64, t_0::Float64=0.)
    # dispatch (robot-only)
    touch("traj.txt")
    n_points = size(traj)[2]
    open("traj.txt", "w") do file
        for i = 1:n_points
            write(file, string(traj[:,i])[2:end-1]*"\n");
        end
        write(file, string(dt)*", "*string(t_0))
    end
    run(`python ros_dispatch.py traj.txt`);
end

function dispatch_trajectory(traj::AbstractMatrix, eef_traj::AbstractMatrix, palm_traj_pred::AbstractMatrix, dt::Float64, t_0::Float64=0.)
    # dispatch (robot and human)
    touch("traj.txt")
    n_points = size(traj)[2]
    open("traj.txt", "w") do file
        for i = 1:n_points
            write(file, string(traj[:,i])[2:end-1]*"\n");
        end
        write(file, string(dt)*", "*string(t_0))
    end
    open("eef-cart-traj.txt", "w") do file
        for i = 1:n_points
            write(file, string(eef_traj[:,i])[2:end-1]*"\n");
        end
    end
    open("palm-cart-traj.txt", "w") do file
        for i = 1:n_points
            write(file, string(palm_traj_pred[:,i])[2:end-1]*"\n");
        end
    end
    run(`python ros_dispatch.py traj.txt eef-cart-traj.txt palm-cart-traj.txt`);
end

function dispatch_human_trajectory(human_trajfile::String, dt::Float64)
    run(`python exec_human_traj.py $human_trajfile $dt`)
end

function move_to(position::AbstractVector, duration::Float64)
    dispatch_trajectory(repeat(position, outer=[1,1]), 0., duration);
end

function test_dispatch()
    traj = hcat([-0.7240388673813724, -0.34790398102523135, 2.830389998766442, -2.540326062072851, 1.3329587647635925, 2.7596249683079757, 0.8505822688022162], [-0.5725474181681542, -0.44092029756514933, 2.7418497072265593, -2.4316382075465977, 1.407493134643918, 2.530425302730846, 0.7870417999270585], [-0.47824362222822775, -0.3902324263721275, 2.619314855738664, -2.365993110522626, 1.4797577078426987, 2.3041239110710694, 0.7235013310519078], [-0.4351722006695235, -0.1667546828201583, 2.4629407240183667, -2.340650807818673, 1.549393490351662, 2.0801658699408905, 0.6599608621767643], [-0.4329371962062105, 0.12713450496958578, 2.271585418611398, -2.340195520590602, 1.6166090181445458, 1.8593679096229345, 0.5964203933016243], [-0.45855646539830675, 0.5384872170624119, 2.0405500532442677, -2.324759841425578, 1.682334993075242, 1.6438393460206249, 0.5328799244265092], [-0.5193603788860224, 0.9004094533310905, 1.8095732826246405, -2.2051489414649867, 1.7579479317688227, 1.4349758614574712, 0.4693394555513941], [-0.5604196466708575, 1.1649662935711913, 1.6274848724311326, -2.042938352434446, 1.837795171857437, 1.2236241539383645, 0.4057989866763039], [-0.5614493474255323, 1.3524958348792784, 1.4922837888249785, -1.875368837692582, 1.9190845763627904, 1.0088381935207278, 0.3422585178012314], [-0.5364252983040207, 1.4881435120983733, 1.3918072918388786, -1.7104975148825265, 2.0009875504085968, 0.7920953563835812, 0.2787180489261838], [-0.5055200763703996, 1.586891934056914, 1.314435954864866, -1.5483469017034721, 2.0842971066566083, 0.574428168778937, 0.21517758005116816], [-0.47626847257892935, 1.6588173338382295, 1.2505906660607133, -1.3890592665833095, 2.168549011576052, 0.355387873997636, 0.1516371111761774], [-0.4496002702535836, 1.712870728257271, 1.1925823108352975, -1.235301609410476, 2.2534331603501445, 0.1342565713205084, 0.08809664230122217], [-0.4262538717284963, 1.7560377091294206, 1.1357684144560651, -1.0880522886529411, 2.3385583331147224, -0.0892338786291036, 0.024556173426306033], [-0.4064711742480501, 1.7925600985186407, 1.078402942083324, -0.9473564650119244, 2.423538153449001, -0.31477263766858943, -0.038984295448578135], [-0.39145646626370784, 1.823536712722894, 1.0206745883009494, -0.8118750666517054, 2.5081177088682565, -0.5415381539376352, -0.10252476432341612], [-0.383235472431474, 1.8461565600804337, 0.9642338279194281, -0.6785406583995235, 2.592254555556227, -0.7681738866558768, -0.16606523319820787], [-0.3827860442730366, 1.8537726457135613, 0.9117531420804815, -0.5429554097938577, 2.6762448920760917, -0.9927165390083166, -0.22960570207295705], [-0.38850721777687847, 1.832441320971309, 0.8676341258674147, -0.3979870850117147, 2.761210453935563, -1.2117988441731051, -0.2931461709476529], [-0.3902233334912561, 1.750102041244326, 0.8403277122863202, -0.2292450508639336, 2.850692656262937, -1.417026666484062, -0.356686639822299])
    joint_start = [-0.7240388673767146, -0.34790398102066433, 2.8303899987665897, -2.54032606205873, 1.3329587647643253, 2.7596249683074614, 0.850582268802067]
    move_to(joint_start, 5.0);
    readline(stdin);
    dispatch_trajectory(traj, 0.5);
end

# test_dispatch()
